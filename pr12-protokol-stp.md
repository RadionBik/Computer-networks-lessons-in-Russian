# Практическая работа №12. Технология Spanning-Tree

Цель: усвоить принципы работы и конфигурации технологии Spanning-Tree

Использование избыточных устройств либо каналов связи является ключевым моментом при построении отказоустойчивых сетей. Возможны различные режимы резервирования устройств и каналов: активный \(балансировка нагрузки\) и пассивный \(простой резерва\). Технология  Spanning-Tree обеспечивает пассивное резервирование. 

В общем, суть технологии сводится к обнаружению логических петель в топологии и блокированию определенных портов на коммутаторах для разрыва этих петель. Как известно, на 2-м уровне нет способа контроля за длительностью передачи кадров в контексте хопов, в отличие от 3-го уровня, где для этих целей используется поле Time-to-live \(TTL\). Таким образом, при попадании в логическую петлю, кадр может передаваться бесконечно долго, пока петля не будет разорвана, подобное зацикливание ведет к "широковещательным штормам". Резервные пути должны управляться таким образом, чтобы не возникало петель на 2-м уровне, за что отвечают Spanning Tree Protocols \(STPs\). При отсутствии/некорректной настройке STP возникают следующие проблемы:

1. Нестабильность MAC-таблицы – когда один и тот же кадр может приходить на разные порты коммутатора, что ведёт к повреждению таблицы.

2. Широковещательный шторм – широковещательные кадры передаются бесконечно из-за наличия петель на коммутаторе, что приводит к истощению всей пропускной способности линков.

3. Многократная передача кадров – одни и те же кадры передаются больше одного раза, что может привести к ошибке в работе некоторых протоколов, где ожидается только однократная передача данных.

Для своей работы,  Spanning-Tree использует специальные сообщения -- Bridge Protocol Data Units \(BPDUs\). Сам процесс описывается следующим образом: 

В начале свитчи **обмениваются BPDU-кадрами** \(каждые 2 сек\), которые содержат Root bridge-ID \(равен своему bridge-ID в начале\), bridge-ID отправителя, root cost -- стоимость пути до Root bridge \(равен 0 в начале\), значения Hello, MaxAge и forward delay таймеров. 

bridge-ID – идентификатор свитча, например: 32769.00112233FFAA, где 32768 -- значение приоритета, 00112233FFAA -- MAC-адрес свитча, и 1 -- расширенный ID системы \(опционально, является идентификатором VLAN\), который суммируется с приоритетом. 

Как было сказано, вместе с BID рассылается root-ID – текущий наименьший найденный bridge-ID, который может обновиться по получении BPDU от другого коммутатора.

Затем **выбирается Root Bridge** – свитч с наименьшим значением BID, где сперва проверяется поле приоритета, если равные -- выбирется наименьший MAC. 

Далее каждый свитч по STA \(Spanning Tree Algorithm\) **рассчитывает кратчайший путь к Root Bridge **для всех портов в широковещательном домене. При расчётах пути учитывается суммарная стоимость портов по их пропускной способности \(см. Таблицу ниже\). Во время этих расчётов передача трафика не происходит.

Таблица стандартных стоимостей портов:

| Скорость | Стоимость \(до ревизии IEEE\) | Стоимость \(после ревизии IEEE\) |
| :--- | :--- | :--- |
| 10 Гб/с | 2 | 2 000 |
| 1 Гб/с | 4 | 20 000 |
| 100 Мб/с | 19 | 200 000 |
| 10 Мб/с | 100 | 2 000 000 |

В зависимости от результатов, портам назначаются следующие роли:

* Root ports – порты свитча, ближайшие к Root Bridge, по одному на каждый свитч.

* Designated ports – все не-Root порты, которым разрешена передача трафика. Выбираются по одному на каждый транк свитча, т.е. если один конец транка – root, то другой – designated. На Root Bridge все порты designated.

* Alternate \(backup\) ports – порты, которые находятся в заблокированном состоянии, для предотвращение петель. Подобные порты выбираются на таких каналах, которые нужно заблокировать \(соответственно ни один из портов не является root\). Блокируемым выбирается тот порт, коммутатор которого имеет наибольшую стоимость до Root Bridge. Если стоимость одинакова, сравниваются bridge-ID  и блокируется тот порт, у у чьего свитча он хуже \(больше\).

Для каждого широковещательного домена создается новая инстанция STP.

Различают несколько реализаций STP:

1. **STP** – оригинальная версия, описана в IEEE 802.1d, считается устаревшей. Признаки – длительность конвергенции порядка 50 сек, 1 общая инстанция для всех VLAN. Низкое потребление ресурсов.

2. **PVST+ **– улучшение для STP от Cisco, где для каждого VLAN запускается собственная инстанция STP \(Per-VLAN Spanning-Tree\), что благоприятно сказывается на управлении потока трафика для каждого VLAN, т.е. может использоваться для балансировки нагрузки на 2-м уровне. Высокое потребление ресурсов при большом количестве VLAN. Выполняет рассылку BPDU для каждого VLAN  в отдельности.

3. **Rapid STP \(RSTP\)** – замещение для STP, описанное в стандарте IEEE 802.1w, имеет гораздо меньшее время конвергенции по сравнению с STP \(от 2 до 10 сек\). Среднее потребление ресурсов.

4. **Rapid PVST+ \(RPVST\)** – аналогично PVST+, но основана на RSTP. Очень высокое потребление ресурсов. 

5. **Multiple Spanning Tree Protocol \(MSTP\)** – IEEE стандарт, где VLAN\`ы с одной и той же логической топологией и теми же требованиями к трафику могут быть объединены в одну инстанцию STP \(вплоть до 16 инстанций\). Среднее потребление ресурсов. Производится только одна общая рассылка BPDU сразу для всех инстанций за счет наличия M-records внутри BPDU.

По умолчанию, на свитчах Cisco работает PVST+. Spanning-Tree спроектирован с учетом обратной совместимости между реализациями протоколов, поэтому в одной сети могут быть устройства работающие на разных версиях, правда за счет понижения производительности в целом. 

С учетом того, что путь рассчитывается по стоимостям портов, эти стоимости можно вручную настраивать, для управления ST путями. Для этого на интерфейсе можно выполнить:

Switch\(config-if\)\# spanning-tree cost 25 % присваиваем стоимость 25

Switch\(config-if\)\# spanning-tree vlan 1 port-priority 25 % присваиваем стоимость 25 на 1 VLAN

Для просмотра стоимости портов и пути до Root Bridge выполнять:

`Switch# show spanning-tree`

 В некоторых случаях, когда может понадобиться задать роль Root Bridge определенным образом, есть 2 пути:

1. Switch\(config\)\# spanning-tree vlan 1 root primary % задаем этот свитч главным

Рис.8 Топология сети

Switch\(config\)\# spanning-tree vlan 1 root secondary % задаем этот свитч второстепенным \(становится главным при отказе primary\)

1. Switch\(config\)\# spanning-tree vlan 1 priority 24576 % 2-й способ, где приоретет свитча задается как кратное 4096

Для повышения эффективности и безопасности работы сети, на Access-портах рекомендуется применять следующие команды:

Switch\(config-if\)\# spanning-tree portfast %переключает порт в режим передачи, не ожидая выполнения STA

Switch\(config-if\)\# spanning-tree bpduguard enable %выключает порт, при попадании на него BPDU, что свидетельствует о наличии свитча на нем и может привести к сетевой петле.

В большинстве случаев, настройка для Rapid PVST+ выполняется аналогично, но сперва нужно активировать её:

Switch\(config\)\# spanning-tree mode rapid-pvst

Для проверки конфигурации также можно использовать:

Switch\# show spanning-tree vlanvlan-id

**Задание:**

1. Дополнить топологию как на Рис.8, при нехватке G-линков, использовать Fa.

2. Настроить Rapid PVST+, в качестве Root Bridge задать S2. Привести теоретические расчеты путей и статусы портов свитчей в этом домене.

3. Показать практические результаты ролей устройств и портов в сети

4. Сделать выводы.

 

