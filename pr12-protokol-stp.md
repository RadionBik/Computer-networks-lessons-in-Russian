# Практическая работа №12. Протоколы STP

Цель: усвоить принципы работы и конфигурации технологии Spanning-Tree

Использование избыточных устройств либо линков является ключевым для поддержания работоспособности сети. Например, когда происходит отказ одного из ликов, «запасной» переходит в активное состояние, тем самым работоспособность сети не нарушается. Также, эти линки могут выполнять функции балансировки трафика. Избыточные пути должны управляться таким образом, чтобы не возникало петель на 2-м уровне. Функции контроля за такими линками выполняют Spanning Tree Protocols \(STP\). При отсутствии/некорректной настройке STP протоколов возникают следующие проблемы:

1. Нестабильность MAC-таблицы – когда один и тот же кадр может приходить на разные порты коммутатора, что ведёт к повреждению таблицы.

2. Широковещательный шторм – широковещательные кадры передаются бесконечно из-за наличия петель на коммутаторе, что приводит к истощению всей пропускной способности линков.

3. Многократная передача кадров – одни и те же кадры передаются больше одного раза, что может привести к ошибке в работе некоторых протоколов, где ожидается только однократная передача данных.

STP выбирает, который из портов на свитче должен быть заблокирован. Сам процесс описывается следующим образом: свитчи обмениваются BPDU-кадрами каждые 2с., которые содержат root-ID и BID, где последнее – идентификатор свитча, который содержит значение приоритета, MAC-адрес свитча и расширенный ID системы \(опционально, является идентификатором VLAN\) – 32768.00112233FFAA как пример. Затем выбирается Root Bridge – свитч с наименьшим значением BID \(по комбинации тех 3 значений\). Вместе с BID рассылается root-ID – текущий наименьший найденный BID. Далее каждый свитч по STA \(Spanning Tree Algorithm\) рассчитывает кратчайший путь к Root Bridge для всех портов в широковещательном домене. При расчётах пути учитывается суммарная стоимость портов \(по их пропускной способности\). Во время этих расчётов передача трафика не происходит. Далее, в зависимости от результатов, портам назначаются следующие роли:

* Root ports – порты свитча, ближайшие к Root Bridge, по одному на каждый свитч.

* Designated ports – все не-Root порты, которым разрешена передача трафика. Выбираются по одному на каждый транк свитча, т.е. если один конец транка – root, то другой – designated. На Root Bridge все порты designated.

* Alternate \(backup\) ports – порты, которые находятся в заблокированном состоянии, для предотвращение петель. Подобные порты выбираются на таких транках, где ни один из портов не является root. При этом, этот статус присваивается порту того свитча, который обладает наибольшим BID, соответственно порту другого свитча достаётся роль designated. Тем не менее, это работает для случая одинаковых стоимостей портов, в противном случае, порт с наибольшей стоимостью будет иметь статус alternate.

Для каждого широковещательного домена создается новая инстанция STP.

Более того, учитывая что путь рассчитывается по стоимостям портов, эти стоимости можно вручную настраивать, для управления ST путями. Для этого на интерфейсе выполнять:

Switch\(config-if\)\# spanning-tree cost 25 % присваиваем стоимость 25

Switch\(config-if\)\# spanning-tree vlan 1 port-priority 25 % присваиваем стоимость 25 на 1 VLAN

  
  


  
  


Таблица стандартных стоимостей портов:

| Скорость | Стоимость \(после ревизии IEEE\) | Стоимость \(до ревизии IEEE\) |
| :--- | :--- | :--- |
| 10 Гб/с | 2 | 1 |
| 1 Гб/с | 4 | 1 |
| 100 Мб/с | 19 | 10 |
| 10 Мб/с | 100 | 100 |

  
  


Для просмотра стоимости портов и пути до Root Bridge выполнять:

Switch\# show spanning-tree

Различают несколько реализаций STP:

1. STP – оригинальная версия, считается устаревшей. Признаки – длительность конвергенции, 1 общая инстанция для всех VLAN. Низкое потребление ресурсов.

2. PVST+ – улучшение для STP от Cisco, где для каждого VLAN запускается собственная инстанция STP, что благоприятно сказывается на управлении потока трафика для каждого VLAN, т.е. может использоваться для балансировки нагрузки на 2-м уровне. Высокое потребление ресурсов.

3. Rapid STP \(RSTP\) – замещение для STP, описанное в стандарте IEEE 802.1d, меньшее время конвергенции по сравнению с STP. Среднее потребление ресурсов.

4. Rapid PVST+ – аналогично PVST+, но в сравнении с RSTP. Очень высокое потребление ресурсов.

5. Multiple Spanning Tree Protocol \(MSTP\) – IEEE стандарт, где VLAN\`ы с одной и той же логической топологией и теми же требованиями к трафику объединяются в одну инстанцию STP \(вплоть до 16 инстанций\). Среднее потребление ресурсов.

По умолчанию, на свитчах Cisco работает PVST+. В некоторых случаях, когда может понадобиться задать роль Root Bridge определенным образом, есть 2 пути:

1. Switch\(config\)\# spanning-tree vlan 1 root primary % задаем этот свитч главным

Рис.8 Топология сети

Switch\(config\)\# spanning-tree vlan 1 root secondary % задаем этот свитч второстепенным \(становится главным при отказе primary\)

2. Switch\(config\)\# spanning-tree vlan 1 priority 24576 % 2-й способ, где приоретет свитча задается как кратное 4096

Для повышения эффективности и безопасности работы сети, на Access-портах рекомендуется применять следующие команды:

Switch\(config-if\)\# spanning-tree portfast %переключает порт в режим передачи, не ожидая выполнения STA

Switch\(config-if\)\# spanning-tree bpduguard enable %выключает порт, при попадании на него BPDU, что свидетельствует о наличии свитча на нем и может привести к сетевой петле.

В большинстве случаев, настройка для Rapid PVST+ выполняется аналогично, но сперва нужно активировать её:

Switch\(config\)\# spanning-tree mode rapid-pvst

Для проверки конфигурации также можно использовать:

Switch\# show spanning-tree vlanvlan-id

**Задание:**

1. Дополнить топологию как на Рис.8, при нехватке G-линков, использовать Fa.

2. Настроить Rapid PVST+, в качестве Root Bridge задать S2. Привести теоретические расчеты путей и статусы портов свитчей в этом домене.

3. Показать практические результаты ролей устройств и портов в сети

4. Сделать выводы.

 

